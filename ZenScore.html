<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ZenScore | Fluid Sheet Music Reader</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

    <style>
        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            /* Background is now handled by React state to ensure theme sync */
            overflow: hidden;
            touch-action: none; 
            margin: 0;
            padding: 0;
        }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

        /* Animations */
        @keyframes fadeInScale { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        @keyframes slideUpFade { from { opacity: 0; transform: translateY(40px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideDownFade { from { opacity: 0; transform: translateY(-40px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pageTurnRight { from { transform: translateX(40px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes pageTurnLeft { from { transform: translateX(-40px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        .anim-enter { animation-duration: 0.6s; animation-timing-function: cubic-bezier(0.22, 1, 0.36, 1); animation-fill-mode: both; }
        .anim-fade-scale { animation-name: fadeInScale; }
        .anim-slide-up { animation-name: slideUpFade; }
        .anim-slide-down { animation-name: slideDownFade; }
        .anim-page-next { animation: pageTurnRight 0.4s cubic-bezier(0.22, 1, 0.36, 1); }
        .anim-page-prev { animation: pageTurnLeft 0.4s cubic-bezier(0.22, 1, 0.36, 1); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect, useCallback } = React;

        // --- Constants ---
        const COLORS = ['#1e1e1e', '#ef4444', '#3b82f6', '#10b981', '#f59e0b', '#8b5cf6', '#ffffff'];
        const STROKE_SIZES = [2, 4, 6, 8, 12, 20];
        const apiKey = ""; 

        const TRANSITIONS = {
            spring: "transition-all duration-500 ease-[cubic-bezier(0.22,1,0.36,1)]",
            slide: "transition-transform duration-500 ease-[cubic-bezier(0.22,1,0.36,1)]",
            fade: "transition-opacity duration-300 ease-in-out"
        };

        // --- Helpers ---
        const getCoordinates = (event, canvasRef) => {
            if (!canvasRef.current) return { x: 0, y: 0 };
            const canvas = canvasRef.current;
            const rect = canvas.getBoundingClientRect();
            const clientX = event.touches ? event.touches[0].clientX : event.clientX;
            const clientY = event.touches ? event.touches[0].clientY : event.clientY;
            return {
                x: (clientX - rect.left) * (canvas.width / rect.width),
                y: (clientY - rect.top) * (canvas.height / rect.height)
            };
        };

        const callGemini = async (prompt, imageBase64 = null, history = []) => {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const contents = history.map(msg => ({ role: msg.role === 'ai' ? 'model' : 'user', parts: [{ text: msg.text }] }));
            const currentParts = [{ text: prompt }];
            if (imageBase64) currentParts.push({ inlineData: { mimeType: "image/png", data: imageBase64 } });
            contents.push({ role: 'user', parts: currentParts });

            const payload = {
                contents: contents,
                systemInstruction: { parts: [{ text: "You are Maestro, an expert music theory and performance assistant. You are helpful, encouraging, and concise." }] }
            };

            try {
                const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (response.ok) {
                    const data = await response.json();
                    return data.candidates[0].content.parts[0].text;
                }
                return "I'm having trouble connecting. Please try again.";
            } catch (error) { return "Network error. Please check your connection."; }
        };

        // --- Components ---
        const Icon = ({ name, size = 24, className = "", ...props }) => {
            const iconKey = name.charAt(0).toLowerCase() + name.slice(1);
            const iconDef = window.lucide.icons[name] || window.lucide.icons[iconKey];
            if (!iconDef) return null;
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
                    {iconDef.map((child, index) => { const Tag = child[0]; return <Tag key={index} {...child[1]} />; })}
                </svg>
            );
        };

        const IconButton = ({ icon, active, onClick, title, disabled, className = "", badge = null, darkMode }) => (
            <button onClick={onClick} title={title} disabled={disabled} className={`p-3 rounded-[16px] ${TRANSITIONS.spring} flex items-center justify-center relative group active:scale-95 hover:scale-105 ${disabled ? 'opacity-30 cursor-not-allowed' : ''} ${active ? 'bg-blue-600 text-white shadow-lg scale-105 ring-1 ring-black/5' : !disabled && (darkMode ? 'hover:bg-white/10 text-zinc-200' : 'hover:bg-white/50 text-[#4a5b6c] hover:shadow-sm')} ${className}`}>
                <Icon name={icon} size={20} />
                {badge && <span className="absolute top-2 right-2 w-2 h-2 bg-[#e17055] rounded-full border border-white"></span>}
                {!disabled && <span className={`absolute -top-10 left-1/2 -translate-x-1/2 ${darkMode ? 'bg-white text-black' : 'bg-white/90 text-[#4a5b6c]'} backdrop-blur border border-white/50 text-[10px] px-3 py-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap z-50 font-medium tracking-wide shadow-sm`}>{title}</span>}
            </button>
        );

        const ColorDot = ({ color, active, onClick, darkMode }) => (
            <button onClick={() => onClick(color)} className={`w-9 h-9 rounded-full border-[3px] ${TRANSITIONS.spring} active:scale-95 shadow-sm ${active ? 'scale-110 border-blue-500 shadow-md ring-2 ring-blue-500/20' : `border-transparent hover:scale-105 ring-1 ${darkMode ? 'ring-white/20' : 'ring-black/5 hover:ring-black/10'}`}`} style={{ backgroundColor: color }} />
        );

        const ChatMessage = ({ role, text, darkMode }) => (
            <div className={`flex w-full mb-4 anim-enter anim-slide-up ${role === 'user' ? 'justify-end' : 'justify-start'}`}>
                <div className={`max-w-[85%] p-5 rounded-[24px] text-sm leading-relaxed shadow-sm border ${role === 'user' ? 'bg-blue-600 text-white rounded-tr-lg border-blue-500' : `${darkMode ? 'bg-zinc-800 text-zinc-100 border-zinc-700' : 'bg-[rgba(255,255,255,0.65)] text-[#4a5b6c] border-white/90'} rounded-tl-lg backdrop-blur-md`}`}>{text}</div>
            </div>
        );

        const PageThumbnail = ({ pdfDoc, pageNum, isActive, onClick, darkMode }) => {
            const canvasRef = useRef(null);
            const [loaded, setLoaded] = useState(false);
            useEffect(() => {
                if (!pdfDoc) return;
                let isCancelled = false;
                const renderThumb = async () => {
                    try {
                        const page = await pdfDoc.getPage(pageNum);
                        if (isCancelled) return;
                        const viewport = page.getViewport({ scale: 0.5 });
                        const canvas = canvasRef.current;
                        if (!canvas) return;
                        canvas.width = viewport.width;
                        canvas.height = viewport.height;
                        const ctx = canvas.getContext('2d');
                        await page.render({ canvasContext: ctx, viewport }).promise;
                        if (!isCancelled) setLoaded(true);
                    } catch (e) {}
                };
                renderThumb();
                return () => { isCancelled = true; };
            }, [pdfDoc, pageNum]);

            return (
                <div onClick={onClick} className={`relative group cursor-pointer flex flex-col items-center ${TRANSITIONS.spring} ${isActive ? 'scale-105' : 'hover:scale-105 opacity-80 hover:opacity-100'} active:scale-100`}>
                    <div className={`relative rounded-[24px] overflow-hidden shadow-lg ${darkMode ? 'bg-zinc-800' : 'bg-white'} ${TRANSITIONS.spring} ${isActive ? 'ring-[3px] ring-[#9fb3a8] shadow-xl' : `ring-1 ${darkMode ? 'ring-white/10' : 'ring-white/80'}`}`}>
                        <canvas ref={canvasRef} className={`w-full h-auto block transition-opacity duration-500 ${loaded ? 'opacity-100' : 'opacity-0'}`} />
                        {!loaded && <div className={`absolute inset-0 animate-pulse ${darkMode ? 'bg-zinc-800' : 'bg-gray-50'}`} />}
                    </div>
                    <div className="absolute -bottom-3 -right-3 z-10"><div className={`flex items-center justify-center w-8 h-8 rounded-full ${darkMode ? 'bg-zinc-800 border-zinc-700 text-zinc-400' : 'bg-white border-white/80 text-[#4a5b6c]'} shadow-md font-sans text-sm ${TRANSITIONS.spring} ${isActive ? 'font-bold' : 'opacity-60'}`}>{pageNum}</div></div>
                </div>
            );
        };

        const LibraryCard = ({ doc, onClick, darkMode }) => (
            <div onClick={onClick} className="group relative flex flex-col gap-3 cursor-pointer anim-enter anim-fade-scale">
                <div className={`relative aspect-[3/4] rounded-[24px] overflow-hidden shadow-lg ring-1 ${darkMode ? 'bg-zinc-900 ring-white/10' : 'bg-[rgba(255,255,255,0.85)] ring-white/90'} backdrop-blur-sm ${TRANSITIONS.spring} group-hover:-translate-y-2 active:-translate-y-1 group-hover:shadow-2xl`}>
                    {doc.thumbnail ? <img src={doc.thumbnail} className="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105 opacity-90 group-hover:opacity-100" alt="Cover" /> : <div className={`w-full h-full flex items-center justify-center ${darkMode ? 'bg-zinc-800/50' : ''}`}><Icon name="FileText" size={40} className={darkMode ? 'text-zinc-600' : "text-[#9fb3a8]"} /></div>}
                    <div className="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500" />
                    <div className="absolute bottom-5 left-5 text-white opacity-0 group-hover:opacity-100 transition-all duration-500 translate-y-2 group-hover:translate-y-0"><p className="text-[10px] font-bold uppercase tracking-widest mb-1 text-[#9fb3a8]">Last opened</p><div className="flex items-center gap-1.5"><Icon name="Clock" size={12} /><p className="text-xs opacity-90 font-medium">{doc.date}</p></div></div>
                </div>
                <div className="px-2 text-center"><h3 className={`font-semibold truncate text-lg ${darkMode ? 'text-zinc-100' : 'text-[#4a5b6c]'}`}>{doc.name}</h3><p className={`text-sm font-medium ${darkMode ? 'text-zinc-500' : 'text-[#4a5b6c]/60'}`}>{doc.numPages} Pages</p></div>
            </div>
        );

        // --- Main Application ---
        function ZenScore() {
            const [viewMode, setViewMode] = useState('library');
            const [library, setLibrary] = useState([]);
            const [activeDoc, setActiveDoc] = useState(null);
            const [file, setFile] = useState(null);
            const [pdfDoc, setPdfDoc] = useState(null);
            const [currentPage, setCurrentPage] = useState(1);
            const [numPages, setNumPages] = useState(0);
            const [mode, setMode] = useState('view');
            const [scale, setScale] = useState(1);
            const [pan, setPan] = useState({ x: 0, y: 0 });
            const [isDrawing, setIsDrawing] = useState(false);
            const [pageStrokes, setPageStrokes] = useState({});
            const [redoStack, setRedoStack] = useState([]);
            const [currentStroke, setCurrentStroke] = useState(null);
            const [color, setColor] = useState('#2d3436');
            const [brushSize, setBrushSize] = useState(4);
            const [showTools, setShowTools] = useState(false);
            const [showMaestro, setShowMaestro] = useState(false);
            const [chatHistory, setChatHistory] = useState([]);
            const [inputMessage, setInputMessage] = useState("");
            const [isAiLoading, setIsAiLoading] = useState(false);
            const [includeContext, setIncludeContext] = useState(false);
            const [animClass, setAnimClass] = useState('');
            const [touchStart, setTouchStart] = useState(null);
            
            // DARK MODE STATE
            const [darkMode, setDarkMode] = useState(() => {
                if (typeof window !== 'undefined') return window.matchMedia('(prefers-color-scheme: dark)').matches;
                return false;
            });

            const canvasRef = useRef(null);
            const containerRef = useRef(null);
            const fileInputRef = useRef(null);
            const chatEndRef = useRef(null);

            // --- Logic ---
            
            const getCanvasImage = () => {
                if (!canvasRef.current) return null;
                return canvasRef.current.toDataURL('image/jpeg', 0.8).split(',')[1];
            };

            const handleSendMessage = async (customPrompt = null, forceImage = false) => {
                const text = customPrompt || inputMessage;
                if (!text.trim()) return;
                if (!customPrompt) setInputMessage("");
                
                const userMessage = { role: 'user', text };
                setChatHistory(prev => [...prev, userMessage]);
                setIsAiLoading(true);

                const imageToSend = (forceImage || includeContext) ? getCanvasImage() : null;
                const responseText = await callGemini(text, imageToSend, [...chatHistory, userMessage]);
                
                setChatHistory(prev => [...prev, { role: 'ai', text: responseText }]);
                setIsAiLoading(false);
            };

            const handleAnalyzePage = () => {
                handleSendMessage("Analyze this page. Identify key signature, time signature, style, and give technical tips.", true);
            };

            const generateThumbnail = async (pdf) => {
                try {
                    const page = await pdf.getPage(1);
                    const viewport = page.getViewport({ scale: 0.5 });
                    const canvas = document.createElement('canvas');
                    canvas.width = viewport.width;
                    canvas.height = viewport.height;
                    const ctx = canvas.getContext('2d');
                    await page.render({ canvasContext: ctx, viewport }).promise;
                    return canvas.toDataURL('image/jpeg', 0.7);
                } catch (e) { return null; }
            };

            const handleFileLoad = (e) => {
                const selectedFile = e.target.files[0];
                if (!selectedFile) return;
                if (selectedFile.type === 'application/pdf') {
                    const reader = new FileReader();
                    reader.onload = async (event) => {
                        try {
                            if (!window.pdfjsLib) { alert("Loading lib..."); return; }
                            const pdf = await window.pdfjsLib.getDocument(new Uint8Array(event.target.result)).promise;
                            const thumb = await generateThumbnail(pdf);
                            const newDoc = { id: Date.now(), name: selectedFile.name.replace('.pdf', ''), file: new Uint8Array(event.target.result), thumbnail: thumb, numPages: pdf.numPages, date: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}), type: 'pdf' };
                            setLibrary(prev => [newDoc, ...prev]);
                            openDocument(newDoc, pdf);
                        } catch (err) { alert("Error loading PDF"); }
                    };
                    reader.readAsArrayBuffer(selectedFile);
                } else if (selectedFile.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const newDoc = { id: Date.now(), name: selectedFile.name, file: event.target.result, thumbnail: event.target.result, numPages: 1, date: new Date().toLocaleTimeString(), type: 'image' };
                        setLibrary(prev => [newDoc, ...prev]);
                        openDocument(newDoc, null);
                    };
                    reader.readAsDataURL(selectedFile);
                }
            };

            const openDocument = (doc, loadedPdf = null) => {
                setPageStrokes({}); setRedoStack([]); setFile(null); setCurrentPage(1); setScale(1); setPan({x:0,y:0}); setChatHistory([]);
                setActiveDoc(doc); setNumPages(doc.numPages);
                if (doc.type === 'pdf') {
                    if (loadedPdf) { setPdfDoc(loadedPdf); setViewMode('overview'); }
                    else { window.pdfjsLib.getDocument(doc.file).promise.then(p => { setPdfDoc(p); setViewMode('overview'); }); }
                } else {
                    const img = new Image(); img.src = doc.file; img.onload = () => { setFile(img); setViewMode('work'); };
                }
            };

            const renderPdfPage = async (pdf, pageNum) => {
                const page = await pdf.getPage(pageNum);
                const viewport = page.getViewport({ scale: 3 });
                const canvas = document.createElement('canvas');
                canvas.width = viewport.width; canvas.height = viewport.height;
                await page.render({ canvasContext: canvas.getContext('2d'), viewport }).promise;
                const img = new Image(); img.src = canvas.toDataURL('image/jpeg');
                img.onload = () => { setFile(img); setPan({x:0,y:0}); };
            };

            const changePage = (offset) => {
                const next = currentPage + offset;
                if (next >= 1 && next <= numPages && pdfDoc) {
                    setAnimClass(offset > 0 ? 'anim-page-next' : 'anim-page-prev');
                    setTimeout(() => setAnimClass(''), 400);
                    setCurrentPage(next);
                    renderPdfPage(pdfDoc, next);
                }
            };

            const jumpToPage = (n) => { setCurrentPage(n); renderPdfPage(pdfDoc, n); setViewMode('work'); };

            const getCurrentStrokes = () => pageStrokes[currentPage] || [];

            const drawCanvas = () => {
                const canvas = canvasRef.current;
                if (!canvas || !file) return;
                const ctx = canvas.getContext('2d');
                if (canvas.width !== file.width || canvas.height !== file.height) { canvas.width = file.width; canvas.height = file.height; }
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(file, 0, 0);
                ctx.lineCap = 'round'; ctx.lineJoin = 'round';
                getCurrentStrokes().forEach(s => { ctx.beginPath(); ctx.strokeStyle=s.color; ctx.lineWidth=s.size; ctx.globalCompositeOperation=s.tool==='erase'?'destination-out':'source-over'; if(s.points.length){ctx.moveTo(s.points[0].x,s.points[0].y); s.points.forEach(p=>ctx.lineTo(p.x,p.y));} ctx.stroke(); });
                if (currentStroke) { ctx.beginPath(); ctx.strokeStyle=currentStroke.color; ctx.lineWidth=currentStroke.size; ctx.globalCompositeOperation=currentStroke.tool==='erase'?'destination-out':'source-over'; if(currentStroke.points.length){ctx.moveTo(currentStroke.points[0].x,currentStroke.points[0].y); currentStroke.points.forEach(p=>ctx.lineTo(p.x,p.y));} ctx.stroke(); }
                ctx.globalCompositeOperation = 'source-over';
            };

            // --- Effects ---
            useEffect(() => { if(window.pdfjsLib) window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js'; }, []);
            useEffect(() => {
                const handleK = (e) => { if (document.activeElement.tagName === 'INPUT' || viewMode !== 'work') return; if(['ArrowRight','PageDown',' ','Enter'].includes(e.key)) changePage(1); if(['ArrowLeft','PageUp'].includes(e.key)) changePage(-1); };
                window.addEventListener('keydown', handleK); return () => window.removeEventListener('keydown', handleK);
            }, [viewMode, currentPage, numPages, pdfDoc]);
            useEffect(() => { if (viewMode === 'work' && file) drawCanvas(); }, [file, pageStrokes, currentStroke]);
            useEffect(() => { const r = () => { if(viewMode === 'work' && file) requestAnimationFrame(drawCanvas); }; window.addEventListener('resize', r); return () => window.removeEventListener('resize', r); }, [file, viewMode]);
            useEffect(() => { chatEndRef.current?.scrollIntoView({ behavior: 'smooth' }); }, [chatHistory, showMaestro]);
            
            // System Theme Listener
            useEffect(() => {
                const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
                const handleChange = (e) => setDarkMode(e.matches);
                mediaQuery.addEventListener('change', handleChange);
                return () => mediaQuery.removeEventListener('change', handleChange);
            }, []);

            // --- Input Handlers ---
            const handleTouchStart = (e) => { setTouchStart({x:e.touches[0].clientX, y:e.touches[0].clientY}); if(mode!=='view') handlePointerDown(e); };
            const handleTouchEnd = (e) => {
                if(!touchStart) return;
                if(mode==='view' && e.changedTouches.length===1) {
                    const diffX = touchStart.x - e.changedTouches[0].clientX;
                    if(Math.abs(diffX)>50) diffX > 0 ? changePage(1) : changePage(-1);
                }
                setTouchStart(null); if(mode!=='view') handlePointerUp(e);
            };
            const handlePointerDown = (e) => { if(mode==='view') return; e.currentTarget.setPointerCapture(e.pointerId); setIsDrawing(true); const {x,y}=getCoordinates(e,canvasRef); setCurrentStroke({tool:mode, color:mode==='erase'?'#000000':color, size:brushSize, points:[{x,y}]}); };
            const handlePointerMove = (e) => { if(!isDrawing||!currentStroke) return; const {x,y}=getCoordinates(e,canvasRef); setCurrentStroke(prev=>({...prev, points:[...prev.points,{x,y}]})); };
            const handlePointerUp = (e) => { if(!isDrawing||!currentStroke) return; setIsDrawing(false); setPageStrokes(prev=>({...prev, [currentPage]:[...(prev[currentPage]||[]), currentStroke]})); setCurrentStroke(null); };
            const undo = () => { const s = getCurrentStrokes(); if(s.length) setPageStrokes(prev=>({...prev, [currentPage]: s.slice(0,-1)})); };
            const redo = () => {}; 
            const handleWheel = (e) => { if(e.ctrlKey) { e.preventDefault(); setScale(s => Math.min(Math.max(0.5, s + (e.deltaY * -0.01)), 4)); } };

            // Dynamic Background
            const appStyle = {
                background: darkMode ? 'linear-gradient(135deg, #18181b 0%, #09090b 100%)' : 'linear-gradient(135deg, #f0f2f5 0%, #eef2f3 100%)',
                color: darkMode ? '#e4e4e7' : '#4a5b6c'
            };

            return (
                <div className={`h-screen w-full overflow-hidden relative select-none ${TRANSITIONS.fade} flex flex-col`} style={appStyle}>
                    {viewMode === 'library' && (
                        <div className="absolute inset-0 z-50 flex flex-col anim-enter anim-fade-scale">
                            <div className="h-24 px-8 flex items-center justify-between">
                                <h1 className="text-lg font-normal tracking-[0.15em] uppercase opacity-70 flex items-center gap-3"><span className="w-2 h-8 bg-[#9fb3a8] rounded-full"></span> ZenFlow</h1>
                                <div className="flex gap-4 items-center">
                                    <button onClick={() => setDarkMode(!darkMode)} className={`p-3 rounded-full ${TRANSITIONS.spring} ${darkMode ? 'hover:bg-white/10 text-zinc-300' : 'hover:bg-black/5 text-slate-600'}`}>
                                        <Icon name={darkMode ? "Sun" : "Moon"} size={20} />
                                    </button>
                                    <button onClick={() => fileInputRef.current?.click()} className={`px-8 py-3 rounded-[16px] font-semibold shadow-lg flex items-center gap-3 ${darkMode ? 'bg-zinc-800 text-zinc-100 hover:bg-zinc-700' : 'bg-white text-[#4a5b6c] hover:shadow-xl'} active:scale-95 ${TRANSITIONS.spring}`}><Icon name="Plus" size={18} /> Import Score</button>
                                    <input type="file" ref={fileInputRef} onChange={handleFileLoad} accept="image/*,application/pdf" className="hidden" />
                                </div>
                            </div>
                            <div className="flex-1 overflow-y-auto p-8 scrollbar-hide">
                                {library.length === 0 ? (
                                    <div className="h-full flex flex-col items-center justify-center pb-32 anim-enter anim-slide-up">
                                        <div className={`w-32 h-32 rounded-[24px] mb-8 flex items-center justify-center ${darkMode ? 'bg-zinc-900 border-zinc-800' : 'bg-[rgba(255,255,255,0.85)] border-white/90'} border shadow-sm`}><Icon name="ImageIcon" size={48} className={darkMode ? "text-zinc-700" : "text-[#9fb3a8]"} /></div>
                                        <h2 className="text-xl font-normal mb-2 opacity-80">Your library is empty</h2>
                                        <p className="text-sm opacity-60 max-w-sm text-center">Import a PDF or image to get started.</p>
                                    </div>
                                ) : (
                                    <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-8 pb-20">
                                        {library.map(doc => <LibraryCard key={doc.id} doc={doc} onClick={() => openDocument(doc)} darkMode={darkMode} />)}
                                    </div>
                                )}
                            </div>
                        </div>
                    )}

                    {viewMode === 'overview' && (
                        <div className={`absolute inset-0 z-40 flex flex-col backdrop-blur-md anim-enter anim-slide-up ${darkMode ? 'bg-zinc-950/90' : 'bg-[#f0f2f5]/90'}`}>
                            <div className={`h-24 flex items-center justify-between px-8 shrink-0 ${darkMode ? 'border-zinc-800' : 'border-slate-200'} border-b`}>
                                <div className="w-1/3"><button onClick={() => setViewMode('library')} className={`flex items-center gap-2 font-semibold px-5 py-2 rounded-[16px] ${TRANSITIONS.spring} ${darkMode ? 'bg-zinc-800/50 text-zinc-300 hover:bg-zinc-800' : 'bg-white/50 text-[#4a5b6c] hover:bg-white'} shadow-sm`}><Icon name="ChevronLeft" size={18} /> Library</button></div>
                                <div className="w-1/3 flex flex-col items-center"><span className={`font-normal text-lg tracking-wide ${darkMode ? 'text-zinc-100' : 'text-[#4a5b6c]'}`}>{activeDoc?.name}</span><span className="text-[10px] font-bold opacity-40 uppercase tracking-[0.2em] mt-1">{activeDoc?.numPages} Pages</span></div>
                                <div className="w-1/3 flex justify-end gap-3">
                                    <button onClick={() => setDarkMode(!darkMode)} className={`p-3 rounded-full ${TRANSITIONS.spring} ${darkMode ? 'hover:bg-white/10 text-zinc-300' : 'hover:bg-black/5 text-slate-600'}`}>
                                        <Icon name={darkMode ? "Sun" : "Moon"} size={20} />
                                    </button>
                                </div>
                            </div>
                            <div className="flex-1 overflow-y-auto p-10 scrollbar-hide">
                                {pdfDoc && (
                                    <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-10 pb-20">
                                        {Array.from({ length: numPages }, (_, i) => i + 1).map((pageNum) => (
                                            <PageThumbnail key={pageNum} pdfDoc={pdfDoc} pageNum={pageNum} isActive={currentPage === pageNum} onClick={() => jumpToPage(pageNum)} darkMode={darkMode} />
                                        ))}
                                    </div>
                                )}
                            </div>
                        </div>
                    )}

                    {viewMode === 'work' && (
                        <>
                            <div className="absolute top-0 left-0 right-0 h-24 pointer-events-none z-20 flex items-center justify-between px-8 anim-enter anim-slide-down">
                                <div className="pointer-events-auto flex items-center gap-4">
                                    <IconButton icon="LayoutGrid" onClick={() => setViewMode('overview')} title="Overview" className={`${darkMode ? 'bg-zinc-900/80 border-zinc-700 text-zinc-100' : 'bg-[rgba(255,255,255,0.65)] border-white/80'} border backdrop-blur-md shadow-sm`} darkMode={darkMode} />
                                    <div className={`flex items-center gap-2 ${darkMode ? 'bg-zinc-900/80 border-zinc-700 text-zinc-100' : 'bg-[rgba(255,255,255,0.65)] border-white/80 text-[#4a5b6c]'} backdrop-blur-md px-5 py-2 rounded-[16px] text-sm font-semibold shadow-sm border ${TRANSITIONS.spring}`}>
                                        <span className="opacity-40 mr-1">PG</span><span className="text-lg">{currentPage}</span><span className="opacity-40">/ {numPages}</span>
                                    </div>
                                </div>
                                <div className="pointer-events-auto flex gap-2">
                                    <IconButton icon="Sparkles" onClick={() => setShowMaestro(!showMaestro)} active={showMaestro} title="Maestro AI" className={`${darkMode ? 'bg-zinc-900/80 border-zinc-700 text-amber-400' : 'bg-[rgba(255,255,255,0.65)] border-white/80 text-[#9fb3a8]'} border backdrop-blur-md shadow-sm`} darkMode={darkMode} />
                                </div>
                            </div>

                            <div ref={containerRef} className={`flex-1 h-full overflow-auto flex items-center justify-center cursor-${mode === 'view' ? 'grab' : 'crosshair'} anim-enter anim-fade-scale`} onWheel={handleWheel} onTouchStart={handleTouchStart} onTouchEnd={handleTouchEnd}>
                                <div className={`relative shadow-[0_20px_50px_rgba(0,0,0,0.1)] origin-center ${animClass}`} style={{ transform: `scale(${scale}) translate(${pan.x}px, ${pan.y}px)` }}>
                                    <canvas ref={canvasRef} className="block bg-white" onTouchMove={handlePointerMove} onPointerDown={handlePointerDown} onPointerMove={handlePointerMove} onPointerUp={handlePointerUp} onPointerLeave={handlePointerUp} />
                                </div>
                            </div>

                            <div className={`absolute bottom-8 left-1/2 -translate-x-1/2 z-30 flex flex-col items-center gap-6 ${TRANSITIONS.slide} ${showMaestro ? '-translate-x-[calc(50%+220px)]' : '-translate-x-1/2'} anim-enter anim-slide-up`}>
                                <div className={`overflow-hidden rounded-[40px] ${darkMode ? 'bg-zinc-900/90 border-zinc-700' : 'bg-[rgba(255,255,255,0.85)] border-white/90'} backdrop-blur-md border shadow-lg ${TRANSITIONS.spring} origin-bottom ${showTools && mode !== 'view' ? 'max-h-96 opacity-100 scale-100 mb-0' : 'max-h-0 opacity-0 scale-90 mb-[-20px] pointer-events-none'}`}>
                                    <div className="p-6 flex flex-col gap-5 min-w-[300px]">
                                        <div className="flex gap-3 justify-center">{COLORS.map(c => <ColorDot key={c} color={c} active={color === c && mode !== 'erase'} onClick={(c) => { setColor(c); setMode('draw'); }} darkMode={darkMode} />)}</div>
                                        <div className={`flex items-center gap-3 pt-4 border-t ${darkMode ? 'border-zinc-700' : 'border-[#4a5b6c]/10'} justify-center`}>
                                            {STROKE_SIZES.map(s => (
                                                <button key={s} onClick={() => setBrushSize(s)} className={`relative flex items-center justify-center w-10 h-10 rounded-full ${TRANSITIONS.spring} active:scale-95 ${brushSize === s ? 'scale-100 opacity-100' : 'scale-75 opacity-40 hover:opacity-100'}`}>
                                                    <div className={`absolute inset-0 rounded-full border-2 ${TRANSITIONS.spring} ${brushSize === s ? 'border-[#74b9ff]' : 'border-transparent'}`} />
                                                    <div className={`rounded-full ${TRANSITIONS.spring} ${brushSize === s ? 'bg-[#74b9ff]' : (darkMode ? 'bg-zinc-600' : 'bg-[#4a5b6c]')}`} style={{ width: `${Math.max(s, 4)}px`, height: `${Math.max(s, 4)}px` }} />
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                </div>

                                <div className={`flex items-center gap-1 p-1.5 px-2 rounded-[50px] backdrop-blur-md ${darkMode ? 'bg-zinc-900/80 border-zinc-700 shadow-black/50' : 'bg-[rgba(255,255,255,0.65)] border-white/80 shadow-sm'} border ${TRANSITIONS.spring}`}>
                                    <div className={`flex items-center overflow-hidden ${TRANSITIONS.spring} ${numPages > 1 ? 'max-w-[120px] opacity-100 mr-2' : 'max-w-0 opacity-0 mr-0'}`}>
                                        <div className="flex items-center gap-1 w-full justify-center">
                                            <IconButton icon="ChevronLeft" onClick={() => { if(currentPage > 1) changePage(-1); }} disabled={currentPage <= 1} title="Prev" darkMode={darkMode} />
                                            <IconButton icon="ChevronRight" onClick={() => { if(currentPage < numPages) changePage(1); }} disabled={currentPage >= numPages} title="Next" darkMode={darkMode} />
                                        </div>
                                    </div>
                                    {numPages > 1 && <div className={`w-px h-6 ${darkMode ? 'bg-zinc-700' : 'bg-[#4a5b6c]/10'} mx-1`}></div>}
                                    <div className="flex items-center gap-1">
                                        <IconButton icon="Minus" onClick={() => setScale(s => Math.max(0.2, s - 0.1))} title="Zoom Out" darkMode={darkMode} />
                                        <span className={`w-12 text-center text-xs font-mono font-bold opacity-60 ${darkMode ? 'text-zinc-400' : 'text-[#4a5b6c]'} ${TRANSITIONS.spring}`}>{Math.round(scale * 100)}%</span>
                                        <IconButton icon="Plus" onClick={() => setScale(s => Math.min(4, s + 0.1))} title="Zoom In" darkMode={darkMode} />
                                    </div>
                                    <div className={`w-px h-6 ${darkMode ? 'bg-zinc-700' : 'bg-[#4a5b6c]/10'} mx-1`}></div>
                                    <div className={`flex items-center gap-1 ${darkMode ? 'bg-zinc-800/50' : 'bg-white/50'} rounded-[40px] p-1 shadow-inner`}>
                                        <IconButton icon="Move" active={mode === 'view'} onClick={() => { setMode('view'); setShowTools(false); }} title="Pan" darkMode={darkMode} />
                                        <IconButton icon="PenTool" active={mode === 'draw'} onClick={() => { setMode('draw'); setShowTools(true); }} title="Pen" darkMode={darkMode} />
                                        <IconButton icon="Eraser" active={mode === 'erase'} onClick={() => { setMode('erase'); setShowTools(true); }} title="Eraser" darkMode={darkMode} />
                                    </div>
                                    <div className={`flex items-center overflow-hidden ${TRANSITIONS.spring} ${mode !== 'view' ? 'max-w-[60px] opacity-100 ml-2' : 'max-w-0 opacity-0 ml-0'}`}>
                                        <div className={`w-px h-6 ${darkMode ? 'bg-zinc-700' : 'bg-[#4a5b6c]/10'} mx-1 shrink-0`}></div>
                                        <IconButton icon={showTools ? "ChevronUp" : "Settings2"} className={`transition-transform duration-300 ${showTools ? `rotate-180 ${darkMode ? 'bg-zinc-700' : 'bg-white'} shadow-sm` : ''}`} onClick={() => setShowTools(!showTools)} title="Tools" darkMode={darkMode} />
                                    </div>
                                    <div className={`flex items-center gap-1 ml-2 pl-2 border-l ${darkMode ? 'border-zinc-700' : 'border-[#4a5b6c]/10'}`}>
                                        <IconButton icon="Undo2" onClick={undo} title="Undo" disabled={getCurrentStrokes().length === 0} darkMode={darkMode} />
                                        <IconButton icon="Redo2" onClick={redo} title="Redo" disabled={redoStack.length === 0} darkMode={darkMode} />
                                    </div>
                                </div>
                            </div>
                        </>
                    )}

                    <div className={`fixed inset-y-0 right-0 w-[400px] z-40 ${darkMode ? 'bg-zinc-900/95 border-zinc-800' : 'bg-[rgba(255,255,255,0.9)] border-white/50'} backdrop-blur-xl border-l shadow-lg transform ${TRANSITIONS.slide} flex flex-col ${showMaestro ? 'translate-x-0' : 'translate-x-full'}`}>
                        <div className={`h-24 flex items-center px-8 shrink-0 border-b ${darkMode ? 'border-zinc-800' : 'border-white/50'} ${TRANSITIONS.spring} justify-between`}>
                            <div className="flex items-center gap-4">
                                <div className={`w-10 h-10 rounded-[12px] ${darkMode ? 'bg-amber-900/30 text-amber-400' : 'bg-[#fdcb6e]/20 text-[#fdcb6e]'} flex items-center justify-center ${TRANSITIONS.spring} shadow-sm`}><Icon name="Sparkles" size={20} /></div>
                                <div><h2 className={`font-semibold text-lg ${darkMode ? 'text-zinc-100' : 'text-[#4a5b6c]'}`}>Maestro</h2><p className={`text-xs font-medium ${darkMode ? 'text-zinc-500' : 'text-[#4a5b6c]/50'}`}>AI Companion</p></div>
                            </div>
                            <button onClick={() => setShowMaestro(false)} className={`opacity-50 hover:opacity-100 p-3 hover:bg-black/5 rounded-full ${TRANSITIONS.spring} active:scale-95`}><Icon name="ChevronRight" size={20} /></button>
                        </div>
                        <div className="flex-1 overflow-y-auto p-6 scrollbar-hide">
                            {chatHistory.length===0 && <div className="text-center p-10 opacity-60"><div className={`w-24 h-24 rounded-[24px] flex items-center justify-center mb-6 shadow-lg mx-auto ${darkMode ? 'bg-zinc-800 text-amber-400' : 'bg-white text-[#fdcb6e]'}`}><Icon name="Sparkles" size={40} /></div>I can analyze your score. <button onClick={handleAnalyzePage} className="block mt-4 text-[#74b9ff] mx-auto">Analyze Page</button></div>}
                            {chatHistory.map((msg, i) => <ChatMessage key={i} role={msg.role} text={msg.text} darkMode={darkMode} />)}
                            {isAiLoading && <div className="p-4 text-sm opacity-50">Thinking...</div>}
                            <div ref={chatEndRef} />
                        </div>
                        <div className={`p-6 border-t ${darkMode ? 'border-zinc-800 bg-zinc-900/50' : 'border-white/50 bg-white/40'} ${TRANSITIONS.spring}`}>
                            <div className="relative">
                                <input type="text" value={inputMessage} onChange={(e) => setInputMessage(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && handleSendMessage()} placeholder="Ask Maestro..." className={`w-full border rounded-[16px] pl-5 pr-14 py-4 text-sm font-medium transition-all shadow-sm focus:outline-none ${darkMode ? 'bg-zinc-800 border-zinc-700 focus:ring-zinc-600 text-white' : 'bg-[rgba(255,255,255,0.5)] border-white/50 focus:bg-white focus:ring-[#74b9ff]/20'} ${TRANSITIONS.spring}`} />
                                <button onClick={() => handleSendMessage()} className={`absolute right-2 top-1/2 -translate-y-1/2 p-2 ${darkMode ? 'text-amber-400' : 'text-[#74b9ff]'}`}><Icon name="Send" size={18} /></button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ZenScore />);
    </script>
</body>
</html>